apiVersion: apps/v1
kind: Deployment
metadata:
  name: nicedishy-api
spec:
  template:
    spec:
      imagePullSecrets:
        - name: ghcr
      serviceAccountName: nicedishy
      containers:
        - name: nicedishy-api
          image: ghcr.io/marc-campbell/nicedishy-gitops/nicedishy-api
          env:
            - name: SESSION_KEY
              value: this-is-not-too-secret
            - name: ENCRYPTION_KEY
              value: this-is-32-bytes-and-not-secret!
            - name: API_ENDPOINT
              value: https://api.nicedishy.com
            - name: WEB_ENDPOINT
              value: https://nicedishy.com
            - name: GOOGLE_CLIENTID
              valueFrom:
                secretKeyRef:
                  name: nicedishy-google
                  key: clientId
            - name: GOOGLE_CLIENTSECRET
              valueFrom:
                secretKeyRef:
                  name: nicedishy-google
                  key: clientSecret
            - name: CORS_ALLOW_ORIGIN
              value: https://nicedishy.com
            - name: GOOGLE_REDIRECTURI
              value: https://nicedishy.com/login/callback
            - name: METRICS_DB_URI
              valueFrom:
                secretKeyRef:
                  name: nicedishy-timescale
                  key: uri
            - name: MOOSEND_API_KEY
              valueFrom:
                secretKeyRef:
                  name: nicedishy-moosend
                  key: apiKey
            - name: MOOSEND_LISTID
              valueFrom:
                secretKeyRef:
                  name: nicedishy-moosend
                  key: listId
            - name: NATS_ENDPOINT
              value: nats://nats.nats.svc.cluster.local:4222
